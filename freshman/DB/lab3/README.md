NOTE: для сложного триггера я поменял структуру и изменил таблицы. Будьте осторожны если захотите разобраться что там происходит, ибо происходящее не будет соответствовать DR.